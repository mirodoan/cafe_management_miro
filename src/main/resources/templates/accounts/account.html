<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout}"
>
<head>
    <meta charset="UTF-8"/>
    <title>Trang cá nhân</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/account.css}"/>
    <style>
        .editable-input {
            background: #fef9c3 !important; /* yellow-100 */
            border-color: #eab308 !important; /* yellow-400 */
            color: #222;
            box-shadow: 0 0 0 2px #fde68a;
            transition: border-color 0.2s, background 0.2s;
            position: relative;
        }
        .editable-input:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
        .editable-input[readonly] {
            background: #f3f4f6 !important;
            border-color: #d1d5db !important;
            color: #6b7280 !important;
            opacity: 0.9;
            box-shadow: none;
        }
        .edit-icon-input {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #eab308;
            background: transparent;
            border-radius: 9999px;
            padding: 2px 4px;
            border: none;
            pointer-events: none;
            z-index: 2;
            font-size: 18px;
            display: flex;
            align-items: center;
        }
        /* Container for input + icon */
        .input-editable-group {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
        }
        .editable-input {
            padding-right: 32px !important;
        }
        /* Avatar edit icon: overlay on avatar */
        .avatar-edit-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            color: #eab308;
            background: #fff;
            border-radius: 9999px;
            box-shadow: 0 1px 4px #eab30833;
            padding: 3px 6px;
            display: flex;
            align-items: center;
            border: 1px solid #fde68a;
            font-size: 19px;
            z-index: 2;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <main class="flex flex-col min-h-screen bg-[var(--color-background-main)] px-2 sm:px-4 md:px-10 pt-4 md:pt-8">
        <form
                class="max-w-xl w-full mx-auto bg-white rounded-xl shadow-lg p-4 sm:p-8 md:p-10"
                th:action="@{/account/update}"
                th:object="${account}"
                method="post"
        >
            <!-- CSRF token -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" th:field="*{id}"/>

            <!-- Header -->
            <div class="bg-gradient-to-r from-yellow-200 to-yellow-400 px-4 py-6 rounded-xl text-center mb-6">
                <div class="flex flex-col items-center mb-4 relative w-fit mx-auto avatar-container">
                    <div style="position: relative;">
                        <img
                                alt="Ảnh đại diện"
                                class="rounded-full border-4 border-white object-cover w-20 h-20 sm:w-28 sm:h-28 md:w-32 md:h-32 mx-auto"
                                id="avatarImage"
                                th:src="*{imageUrl != null and !#strings.isEmpty(imageUrl)} ? *{imageUrl} : 'https://randomuser.me/api/portraits/men/32.jpg'"
                        />
                    </div>
                    <div class="input-editable-group w-full mt-2">
                        <input
                                type="text"
                                id="avatarUrlInput"
                                th:field="*{imageUrl}"
                                placeholder="Nhập URL ảnh đại diện hoặc để trống"
                                class="editable-input w-full border rounded-xl px-4 py-2 focus:ring-blue-400"
                                pattern="^$|^(https?://).*(jpg|jpeg|png|gif|bmp|webp)(\?.*)?$"
                                th:attr="readonly=${!editMode},style=${editMode ? '' : 'display: none'}"
                        />
                        <span class="edit-icon-input" th:if="${editMode}">
                            <i class="fas fa-pen"></i>
                        </span>
                    </div>
                    <p class="text-red-500 text-sm mt-1"
                       th:if="${#fields.hasErrors('imageUrl')}"
                       th:errors="*{imageUrl}"></p>
                </div>
                <h3 class="text-xl md:text-2xl font-bold mb-2" th:text="*{fullName}">Tên người dùng</h3>
                <div class="flex justify-center">
                    <input
                            type="text"
                            th:field="*{positionName}"
                            placeholder="Chưa có thông tin"
                            disabled
                            class="text-center font-semibold text-yellow-700 bg-white px-4 py-1 rounded-full shadow w-auto border-none outline-none"
                            style="min-width: 140px"
                    />
                    <input type="hidden" th:field="*{positionName}"/>
                </div>
            </div>

            <!-- Thông tin cá nhân -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <!-- Họ tên -->
                <div class="info-field relative" th:classappend="${editMode} ? 'editing' : ''">
                    <label for="fullName" class="font-semibold mb-1 block">* HỌ TÊN</label>
                    <div class="input-editable-group">
                        <input
                                id="fullName"
                                th:field="*{fullName}"
                                th:attr="readonly=${!editMode}"
                                type="text"
                                class="editable-input w-full border rounded-xl px-4 py-2 text-base md:text-lg"
                                required
                                minlength="5"
                                maxlength="20"
                                pattern="^(?!\s*$).{5,20}$"
                                oninvalid="this.setCustomValidity('Họ tên phải nhập từ 5 đến 20 ký tự')"
                                oninput="this.setCustomValidity('')"
                        />
                        <span class="edit-icon-input" th:if="${editMode}">
                            <i class="fas fa-pen"></i>
                        </span>
                    </div>
                    <p class="text-red-500 text-sm mt-1"
                       th:if="${#fields.hasErrors('fullName')}"
                       th:errors="*{fullName}"></p>
                </div>

                <!-- Tên đăng nhập -->
                <div>
                    <label for="username" class="font-semibold mb-1 block">TÊN ĐĂNG NHẬP</label>
                    <input
                            id="username"
                            th:field="*{username}"
                            readonly
                            type="text"
                            class="w-full border border-gray-300 rounded-xl px-4 py-2 bg-gray-100 text-base md:text-lg"
                    />
                </div>

                <!-- Mật khẩu -->
                <div class="info-field relative" th:classappend="${editMode} ? 'editing' : ''">
                    <label for="password" class="font-semibold mb-1 block">MẬT KHẨU</label>
                    <input
                            id="password"
                            value="*******"
                            readonly
                            type="password"
                            class="w-full border border-gray-300 rounded-xl px-4 py-2 bg-gray-100 text-base md:text-lg"
                            th:if="${!editMode}"
                    />
                    <!-- Nếu đang chỉnh sửa -->
                    <div class="input-editable-group" th:if="${editMode}">
                        <input
                                type="password"
                                th:field="*{password}"
                                id="newPassword"
                                pattern="^$|.{6,20}"
                                minlength="0"
                                maxlength="20"
                                placeholder="Nhập mật khẩu mới"
                                class="editable-input w-full border rounded-xl px-4 py-2 bg-white text-base md:text-lg"
                                autocomplete="new-password"
                                oninvalid="this.setCustomValidity('Mật khẩu mới phải có từ 6 đến 20 ký tự nếu được nhập')"
                                oninput="this.setCustomValidity('')"
                        />
                        <span class="edit-icon-input">
                            <i class="fas fa-pen"></i>
                        </span>
                    </div>
                    <p class="text-red-500 text-sm mt-1"
                       th:if="${#fields.hasErrors('password')}"
                       th:errors="*{password}"
                       id="passwordError"></p>
                </div>

                <!-- Số điện thoại -->
                <div class="info-field relative" th:classappend="${editMode} ? 'editing' : ''">
                    <label for="phoneNumber" class="font-semibold mb-1 block">* SỐ ĐIỆN THOẠI</label>
                    <div class="input-editable-group">
                        <input
                                id="phoneNumber"
                                th:field="*{phoneNumber}"
                                th:attr="readonly=${!editMode}"
                                type="text"
                                class="editable-input w-full border rounded-xl px-4 py-2 text-base md:text-lg"
                                required
                                minlength="10"
                                maxlength="11"
                                pattern="^0[0-9]{9,10}$"
                                oninvalid="this.setCustomValidity('Số điện thoại phải bắt đầu bằng số 0 và có 10 - 11 chữ số')"
                                oninput="this.setCustomValidity('')"
                        />
                        <span class="edit-icon-input" th:if="${editMode}">
                            <i class="fas fa-pen"></i>
                        </span>
                    </div>
                    <p class="text-red-500 text-sm mt-1"
                       th:if="${#fields.hasErrors('phoneNumber')}"
                       th:errors="*{phoneNumber}"></p>
                </div>

                <!-- Địa chỉ -->
                <div class="info-field relative" th:classappend="${editMode} ? 'editing' : ''">
                    <label for="address" class="font-semibold mb-1 block">ĐỊA CHỈ</label>
                    <div class="input-editable-group">
                        <input
                                id="address"
                                th:field="*{address}"
                                th:attr="readonly=${!editMode}"
                                type="text"
                                class="editable-input w-full border rounded-xl px-4 py-2 text-base md:text-lg"
                                minlength="5"
                                maxlength="50"
                                pattern="^$|^(?!\s*$).{5,30}$"
                                oninvalid="this.setCustomValidity('Địa chỉ phải nhập từ 5 đến 50 ký tự')"
                                oninput="this.setCustomValidity('')"
                        />
                        <span class="edit-icon-input" th:if="${editMode}">
                            <i class="fas fa-pen"></i>
                        </span>
                    </div>
                    <p class="text-red-500 text-sm mt-1"
                       th:if="${#fields.hasErrors('address')}"
                       th:errors="*{address}"></p>
                </div>

                <!-- Lương -->
                <div>
                    <label class="font-semibold mb-1 block">LƯƠNG (VND)</label>
                    <input
                            type="text"
                            th:value="${account.salary != null ? #numbers.formatDecimal(account.salary, 0, 'COMMA', 0, 'POINT') : 'Chưa có thông tin'}"
                            readonly
                            class="w-full px-3 py-2 border rounded bg-gray-100 text-base md:text-lg"
                    />
                    <input type="hidden" th:field="*{salary}"/>
                </div>
            </div>

            <!-- Nút hành động -->
            <div class="flex flex-col gap-3 mt-8 w-full items-center sm:flex-row sm:justify-center sm:items-center">
                <!-- Chỉ hiện nút Chỉnh sửa ở chế độ xem -->
                <button
                        class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-6 py-2 rounded-lg shadow flex items-center gap-2"
                        id="editButton"
                        type="button"
                        onclick="window.location.href='/account/edit'"
                        th:if="${!editMode}"
                >
                    <i class="fas fa-pen"></i> Chỉnh sửa
                </button>
                <!-- Hiện nút Lưu và Hủy ở chế độ chỉnh sửa -->
                <button
                        class="bg-green-500 hover:bg-green-600 text-white font-semibold px-6 py-2 rounded-lg shadow flex items-center gap-2"
                        id="saveButton"
                        type="submit"
                        th:disabled="${#fields.hasErrors()}"
                        th:if="${editMode}"
                >
                    <i class="fas fa-save"></i> Lưu thay đổi
                </button>
                <button
                        class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold px-6 py-2 rounded-lg shadow flex items-center gap-2"
                        id="cancelButton"
                        type="button"
                        onclick="window.location.href='/account'"
                        th:if="${editMode}"
                >
                    <i class="fas fa-times"></i> Hủy
                </button>
            </div>
            <div class="mt-6">
                <p class="text-base text-gray-600 mb-6 text-left">
                    Lưu ý: <span class="font-bold text-red-500">*</span> là các trường bắt buộc nhập
                </p>
            </div>
        </form>
    </main>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            var firstInput = document.querySelector('input.editable-input:not([readonly])');
            if (firstInput) {
                firstInput.focus();
            }
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="/js/account/account.js"></script>
</div>
</body>
</html>