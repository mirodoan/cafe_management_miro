<div xmlns:th="http://www.thymeleaf.org" th:fragment="payment-modal">
    <div
            th:if="${showPaymentModal} and ${orderDetail != null}"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"
    >
        <div class="bg-white rounded-2xl shadow-2xl px-4 py-6 sm:p-8 w-full max-w-md sm:max-w-lg md:max-w-xl lg:max-w-2xl relative border border-[#b5c99a] flex flex-col"
             style="max-height: 92vh; display: flex; flex-direction: column;">
            <!-- Header sticky -->
            <div class="sticky top-0 z-10 bg-white rounded-t-2xl flex items-center justify-center gap-3 px-4 py-2"
                 style="border-bottom: 1px solid #e5e7eb;">
                <h3
                        class="text-xl sm:text-2xl md:text-3xl font-extrabold text-center tracking-tight break-words m-0"
                        style="color: #3e2723"
                >
                    Thanh toán -
                    <span th:text="${orderDetail.tableName}"></span>
                </h3>
                <button
                        type="button"
                        onclick="closePaymentModal()"
                        class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl"
                >×
                </button>
            </div>
            <!-- Thông tin khách hàng -->
            <div class="mb-3">
                <div class="grid grid-cols-2 gap-3 items-end">
                    <div>
                        <label class="block text-base font-semibold text-[#3e2723] mb-1">Khách hàng</label>
                        <div class="w-full rounded-lg border border-[#b5c99a] bg-[#f6e7cb] px-3 py-2 text-base truncate"
                             style="min-width: 0;">
                            <span th:text="${orderDetail.customerName ?: '---'}"></span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-base font-semibold text-[#3e2723] mb-1">Số điện thoại</label>
                        <div class="w-full rounded-lg border border-[#b5c99a] bg-[#f6e7cb] px-3 py-2 text-base truncate"
                             style="min-width: 0;">
                            <span th:text="${orderDetail.customerPhone ?: '---'}"></span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Table món ăn -->
            <div class="overflow-x-auto mb-3" style="max-height: 230px;">
                <table class="min-w-full border rounded-lg text-sm sm:text-base">
                    <thead>
                    <tr class="bg-gray-200">
                        <th class="px-2 py-1 sm:px-4 sm:py-2 text-left">Tên món</th>
                        <th class="px-2 py-1 sm:px-4 sm:py-2 text-center">Số lượng</th>
                        <th class="px-2 py-1 sm:px-4 sm:py-2 text-center">Đơn giá</th>
                        <th class="px-2 py-1 sm:px-4 sm:py-2 text-center">Thành tiền</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${orderDetail.items == null or #lists.isEmpty(orderDetail.items)}">
                        <td colspan="4" class="text-center text-gray-500">Chưa có thông tin chọn món</td>
                    </tr>
                    <tr th:each="item : ${orderDetail.items}">
                        <td class="px-2 py-1 sm:px-4 sm:py-2 break-words" th:text="${item.menuItemName}"></td>
                        <td class="px-2 py-1 sm:px-4 sm:py-2 text-center" th:text="${item.quantity}"></td>
                        <td class="px-2 py-1 sm:px-4 sm:py-2 text-center"
                            th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}"></td>
                        <td class="px-2 py-1 sm:px-4 sm:py-2 text-center"
                            th:text="${#numbers.formatDecimal(item.amount, 0, 'COMMA', 0, 'POINT')}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- Tổng tiền -->
            <div class="flex flex-row justify-end items-center gap-2 mb-2 sm:mb-2">
                <span class="font-bold text-base sm:text-lg text-[#3e2723]">Tổng tiền (VND):</span>
                <span
                        id="totalAmountValue"
                        class="font-bold text-base sm:text-lg text-[#3e2723]"
                        th:text="${#numbers.formatDecimal(orderDetail.totalAmount ?: 0, 0, 'COMMA', 0, 'POINT')}">
                </span>
            </div>
            <!-- Form nhập tiền khách đưa và tiền thừa (2 hàng ngang) -->
            <form
                    id="payment-form"
                    th:action="@{/sale/pay-invoice}"
                    method="post"
                    class="mt-1 flex flex-col items-center w-full"
            >
                <!-- CSRF token -->
                <input
                        type="hidden"
                        th:name="${_csrf.parameterName}"
                        th:value="${_csrf.token}"
                />
                <input
                        type="hidden"
                        name="tableId"
                        th:value="${orderDetail.tableId}"
                />

                <!-- Đưa về 2 hàng ngang: Hàng 1 là Khách đưa + input + lỗi. Hàng 2 là Tiền thừa + value -->
                <div class="flex flex-row items-center justify-center w-full gap-3 mb-0">
                    <label for="customerPaid"
                           class="block text-base font-semibold text-[#3e2723] mb-0 mr-2 min-w-[80px] text-right">
                        Khách đưa:
                    </label>
                    <div class="flex flex-col" style="min-width:0;">
                        <input
                                type="text"
                                id="customerPaid"
                                name="customerPaid"
                                maxlength="11"
                                class="border border-gray-400 rounded px-3 py-2 text-right font-bold text-base sm:text-lg"
                                placeholder="0"
                                autocomplete="off"
                                oninput="validateInput(this)"
                                onpaste="return handlePaste(event)"
                                style="width: 180px;"
                        />
                        <span
                                id="customerPaidError"
                                class="text-red-500 text-xs sm:text-sm mt-1 min-h-[18px] sm:min-h-[20px] block"
                                style="height: 18px;"
                        ></span>
                    </div>
                </div>
                <div class="flex flex-row items-center justify-center w-full gap-3 mt-2 mb-2">
                    <label class="block text-base font-semibold text-[#3e2723] mb-0 mr-2 min-w-[160px] text-right">
                        Tiền thừa của khách:
                    </label>
                    <span id="changeAmount" class="font-bold text-base sm:text-lg text-[#3e2723] block ml-2"
                          style="width:120px;text-align:right;">0</span>
                </div>
                <!-- Nút xác nhận & hủy: đẹp, ngắn, căn giữa -->
                <div class="flex justify-center gap-3 pt-1 pb-1 w-full">
                    <button
                            type="submit"
                            class="px-7 py-2 rounded-lg font-semibold text-white bg-green-500 hover:bg-green-600 shadow min-w-[110px] text-base sm:text-lg"
                    >Xác nhận thanh toán
                    </button>
                    <button
                            type="button"
                            onclick="closePaymentModal()"
                            class="px-7 py-2 rounded-lg font-semibold text-white bg-gray-500 hover:bg-gray-600 shadow min-w-[110px] text-base sm:text-lg"
                    >Hủy
                    </button>
                </div>
            </form>
            <script>
                const MAX_PAID = 999999999;
                function formatVND(num) {
                    return num.toLocaleString('en-US');
                }
                function parseVND(str) {
                    if (!str) return 0;
                    return parseInt(str.replace(/[.,]/g, ''), 10) || 0;
                }
                function validateInput(input) {
                    let value = input.value.replace(/[^0-9]/g, '');
                    if (value.length > 11) value = value.substring(0, 11);
                    let num = parseInt(value || '0', 10);
                    if (num > MAX_PAID) num = MAX_PAID;
                    input.value = num ? num.toLocaleString('en-US') : '';
                    updateChange();
                }
                function handlePaste(event) {
                    event.preventDefault();
                    const paste = (event.clipboardData || window.clipboardData).getData('text');
                    let cleanPaste = paste.replace(/[^0-9]/g, '');
                    if (cleanPaste.length > 11) cleanPaste = cleanPaste.substring(0, 11);
                    let num = parseInt(cleanPaste || '0', 10);
                    if (num > MAX_PAID) num = MAX_PAID;
                    event.target.value = num ? num.toLocaleString('en-US') : '';
                    updateChange();
                    return false;
                }
                const totalAmountEl = document.getElementById('totalAmountValue');
                const customerPaidInput = document.getElementById('customerPaid');
                const changeAmountEl = document.getElementById('changeAmount');
                const errorEl = document.getElementById('customerPaidError');
                let totalAmount = 0;
                if (totalAmountEl) {
                    totalAmount = parseVND(totalAmountEl.textContent);
                }
                function validatePaid(value) {
                    if (!value || value.trim() === '') return 'Vui lòng nhập số tiền khách đưa.';
                    const num = parseVND(value);
                    if (isNaN(num) || num <= 0) return 'Số tiền không hợp lệ.';
                    if (num < totalAmount) return 'Số tiền khách đưa phải lớn hơn hoặc bằng tổng tiền.';
                    if (num > MAX_PAID) return 'Tối đa chỉ nhận 99,999,999,999 VND.';
                    return '';
                }
                function updateChange() {
                    const value = customerPaidInput.value.trim();
                    const errorMsg = validatePaid(value);
                    if (errorMsg) {
                        errorEl.textContent = errorMsg;
                        errorEl.style.display = 'block';
                        changeAmountEl.textContent = '0';
                        return false;
                    } else {
                        errorEl.textContent = '';
                        errorEl.style.display = 'none';
                        const paid = parseVND(value);
                        const change = paid - totalAmount;
                        changeAmountEl.textContent = formatVND(change);
                        return true;
                    }
                }
                customerPaidInput.addEventListener('input', updateChange);
                customerPaidInput.addEventListener('paste', handlePaste);
                document.getElementById('payment-form').addEventListener('submit', function (e) {
                    if (!updateChange()) {
                        e.preventDefault();
                        customerPaidInput.focus();
                        return false;
                    }
                });
            </script>
        </div>
    </div>
    <div
            th:if="${showPaymentModal} and ${orderDetail == null}"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"
    >
        <div class="bg-white rounded-2xl shadow-2xl px-2 py-4 sm:p-6 md:p-8 max-w-[95vw] w-full max-w-md sm:max-w-lg md:max-w-xl relative border border-[#b5c99a] flex flex-col items-center">
            <button
                    type="button"
                    onclick="closePaymentModal()"
                    class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl"
            >×
            </button>
            <h3 class="text-lg sm:text-2xl font-bold mb-4 text-center text-[#3e2723]">
                Không có thông tin hóa đơn để thanh toán!
            </h3>
            <button
                    type="button"
                    onclick="closePaymentModal()"
                    class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold shadow mt-4 text-base sm:text-lg"
            >Đóng
            </button>
        </div>
    </div>
    <script>
        function closePaymentModal() {
            window.location.href = '/sale';
        }
    </script>
</div>